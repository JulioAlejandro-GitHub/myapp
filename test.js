{
    "detection": {
        "_imageDims": {
            "_width": 640,
            "_height": 480
        },
        "_score": 0.9969726800918579,
        "_classScore": 0.9969726800918579,
        "_className": "",
        "_box": {
            "_x": 226.61260604858398,
            "_y": 243.36925506591797,
            "_width": 114.35388565063477,
            "_height": 97.59723663330077
        }
    },
    "landmarks": {
        "_imgDims": {
            "_width": 114,
            "_height": 97
        },
        "_shift": {
            "_x": 226.61260604858398,
            "_y": 243.36925506591797
        },
        "_positions": [
            {
                "_x": 245.96294128894806,
                "_y": 312.1531063914299
            },
            {
                "_x": 253.49101141095161,
                "_y": 312.4383556842804
            },
            {
                "_x": 267.49246138334274,
                "_y": 319.55204647779465
            },
            {
                "_x": 278.4327429533005,
                "_y": 320.0701344013214
            },
            {
                "_x": 284.45028495788574,
                "_y": 316.9025068283081
            },
            {
                "_x": 292.50502157211304,
                "_y": 312.64942640066147
            },
            {
                "_x": 292.63940489292145,
                "_y": 313.1923176050186
            },
            {
                "_x": 293.97148966789246,
                "_y": 310.8641047477722
            },
            {
                "_x": 301.21910417079926,
                "_y": 306.8182097673416
            },
            {
                "_x": 304.57577216625214,
                "_y": 296.1593438386917
            },
            {
                "_x": 307.42101979255676,
                "_y": 292.14678007364273
            },
            {
                "_x": 300.0197855234146,
                "_y": 294.3533990383148
            },
            {
                "_x": 299.0838179588318,
                "_y": 293.570459485054
            },
            {
                "_x": 301.31360125541687,
                "_y": 288.85202267766
            },
            {
                "_x": 303.8554416894913,
                "_y": 284.26711598038673
            },
            {
                "_x": 313.7762562036514,
                "_y": 281.2820208966732
            },
            {
                "_x": 308.61237478256226,
                "_y": 275.8884318470955
            },
            {
                "_x": 240.92622357606888,
                "_y": 306.65079629421234
            },
            {
                "_x": 244.95464849472046,
                "_y": 299.4181249141693
            },
            {
                "_x": 247.0739309489727,
                "_y": 296.97536021471024
            },
            {
                "_x": 252.63110628724098,
                "_y": 291.5524119436741
            },
            {
                "_x": 257.69763845205307,
                "_y": 292.1335805654526
            },
            {
                "_x": 274.8618885874748,
                "_y": 280.34522584080696
            },
            {
                "_x": 273.3106877207756,
                "_y": 282.1899481713772
            },
            {
                "_x": 280.2520003914833,
                "_y": 277.3002299666405
            },
            {
                "_x": 285.3132953643799,
                "_y": 271.5666943192482
            },
            {
                "_x": 297.7121731042862,
                "_y": 273.21319565176964
            },
            {
                "_x": 272.1022197008133,
                "_y": 295.8483604192734
            },
            {
                "_x": 272.02940863370895,
                "_y": 296.29026931524277
            },
            {
                "_x": 270.11315697431564,
                "_y": 295.5281957387924
            },
            {
                "_x": 272.2635822892189,
                "_y": 297.76014989614487
            },
            {
                "_x": 275.53135561943054,
                "_y": 300.6909784078598
            },
            {
                "_x": 275.3270898461342,
                "_y": 299.3428767323494
            },
            {
                "_x": 277.8038212656975,
                "_y": 298.5464948415756
            },
            {
                "_x": 278.54011982679367,
                "_y": 297.3674428462982
            },
            {
                "_x": 279.59176766872406,
                "_y": 298.20083886384964
            },
            {
                "_x": 258.74446189403534,
                "_y": 305.919226706028
            },
            {
                "_x": 257.09381383657455,
                "_y": 303.2156575322151
            },
            {
                "_x": 262.14224940538406,
                "_y": 302.13947266340256
            },
            {
                "_x": 266.58088421821594,
                "_y": 301.0572922229767
            },
            {
                "_x": 266.5643555521965,
                "_y": 306.0510599017143
            },
            {
                "_x": 261.54389810562134,
                "_y": 305.9063856601715
            },
            {
                "_x": 278.54274946451187,
                "_y": 293.44009482860565
            },
            {
                "_x": 281.36667799949646,
                "_y": 286.6130958497524
            },
            {
                "_x": 284.4785178899765,
                "_y": 284.2706341147423
            },
            {
                "_x": 284.62594747543335,
                "_y": 284.69374108314514
            },
            {
                "_x": 285.4841606616974,
                "_y": 286.73573622107506
            },
            {
                "_x": 280.68100506067276,
                "_y": 291.32215481996536
            },
            {
                "_x": 284.15977454185486,
                "_y": 303.4377538561821
            },
            {
                "_x": 283.26959121227264,
                "_y": 302.6766342520714
            },
            {
                "_x": 279.9648092985153,
                "_y": 297.1162648200989
            },
            {
                "_x": 281.7768199443817,
                "_y": 296.10173547267914
            },
            {
                "_x": 280.92052632570267,
                "_y": 293.6563285589218
            },
            {
                "_x": 283.24182373285294,
                "_y": 294.77533811330795
            },
            {
                "_x": 288.3685131072998,
                "_y": 292.79546970129013
            },
            {
                "_x": 284.798552274704,
                "_y": 290.3659999072552
            },
            {
                "_x": 285.7169005870819,
                "_y": 295.44765734672546
            },
            {
                "_x": 286.2885036468506,
                "_y": 296.606392621994
            },
            {
                "_x": 289.72629630565643,
                "_y": 301.2630958557129
            },
            {
                "_x": 286.19598388671875,
                "_y": 301.5624523758888
            },
            {
                "_x": 283.3500329852104,
                "_y": 303.6554387807846
            },
            {
                "_x": 284.5324968099594,
                "_y": 298.53073984384537
            },
            {
                "_x": 286.2579264640808,
                "_y": 297.5282999277115
            },
            {
                "_x": 282.9303951263428,
                "_y": 294.3986173272133
            },
            {
                "_x": 287.4344209432602,
                "_y": 293.18842536211014
            },
            {
                "_x": 282.4079262018204,
                "_y": 291.6474854052067
            },
            {
                "_x": 282.4422745704651,
                "_y": 295.0451446175575
            },
            {
                "_x": 283.1267040371895,
                "_y": 296.6775300502777
            }
        ]
    },
    "unshiftedLandmarks": {
        "_imgDims": {
            "_width": 114,
            "_height": 97
        },
        "_shift": {
            "_x": 0,
            "_y": 0
        },
        "_positions": [
            {
                "_x": 19.350335240364075,
                "_y": 68.78385132551193
            },
            {
                "_x": 26.87840536236763,
                "_y": 69.06910061836243
            },
            {
                "_x": 40.87985533475876,
                "_y": 76.18279141187668
            },
            {
                "_x": 51.82013690471649,
                "_y": 76.70087933540344
            },
            {
                "_x": 57.83767890930176,
                "_y": 73.53325176239014
            },
            {
                "_x": 65.89241552352905,
                "_y": 69.2801713347435
            },
            {
                "_x": 66.02679884433746,
                "_y": 69.82306253910065
            },
            {
                "_x": 67.35888361930847,
                "_y": 67.49484968185425
            },
            {
                "_x": 74.60649812221527,
                "_y": 63.448954701423645
            },
            {
                "_x": 77.96316611766815,
                "_y": 52.79008877277374
            },
            {
                "_x": 80.80841374397278,
                "_y": 48.77752500772476
            },
            {
                "_x": 73.40717947483063,
                "_y": 50.98414397239685
            },
            {
                "_x": 72.4712119102478,
                "_y": 50.20120441913605
            },
            {
                "_x": 74.70099520683289,
                "_y": 45.48276761174202
            },
            {
                "_x": 77.24283564090729,
                "_y": 40.897860914468765
            },
            {
                "_x": 87.16365015506744,
                "_y": 37.912765830755234
            },
            {
                "_x": 81.99976873397827,
                "_y": 32.51917678117752
            },
            {
                "_x": 14.313617527484894,
                "_y": 63.28154122829437
            },
            {
                "_x": 18.342042446136475,
                "_y": 56.04886984825134
            },
            {
                "_x": 20.461324900388718,
                "_y": 53.60610514879227
            },
            {
                "_x": 26.018500238656998,
                "_y": 48.18315687775612
            },
            {
                "_x": 31.085032403469086,
                "_y": 48.76432549953461
            },
            {
                "_x": 48.24928253889084,
                "_y": 36.97597077488899
            },
            {
                "_x": 46.69808167219162,
                "_y": 38.82069310545921
            },
            {
                "_x": 53.63939434289932,
                "_y": 33.930974900722504
            },
            {
                "_x": 58.7006893157959,
                "_y": 28.19743925333023
            },
            {
                "_x": 71.09956705570221,
                "_y": 29.84394058585167
            },
            {
                "_x": 45.48961365222931,
                "_y": 52.47910535335541
            },
            {
                "_x": 45.41680258512497,
                "_y": 52.9210142493248
            },
            {
                "_x": 43.50055092573166,
                "_y": 52.15894067287445
            },
            {
                "_x": 45.65097624063492,
                "_y": 54.3908948302269
            },
            {
                "_x": 48.91874957084656,
                "_y": 57.32172334194183
            },
            {
                "_x": 48.7144837975502,
                "_y": 55.97362166643143
            },
            {
                "_x": 51.191215217113495,
                "_y": 55.177239775657654
            },
            {
                "_x": 51.927513778209686,
                "_y": 53.99818778038025
            },
            {
                "_x": 52.979161620140076,
                "_y": 54.83158379793167
            },
            {
                "_x": 32.131855845451355,
                "_y": 62.549971640110016
            },
            {
                "_x": 30.48120778799057,
                "_y": 59.84640246629715
            },
            {
                "_x": 35.52964335680008,
                "_y": 58.77021759748459
            },
            {
                "_x": 39.96827816963196,
                "_y": 57.688037157058716
            },
            {
                "_x": 39.95174950361252,
                "_y": 62.681804835796356
            },
            {
                "_x": 34.93129205703735,
                "_y": 62.53713059425354
            },
            {
                "_x": 51.93014341592789,
                "_y": 50.07083976268768
            },
            {
                "_x": 54.754071950912476,
                "_y": 43.24384078383446
            },
            {
                "_x": 57.86591184139252,
                "_y": 40.90137904882431
            },
            {
                "_x": 58.013341426849365,
                "_y": 41.32448601722717
            },
            {
                "_x": 58.8715546131134,
                "_y": 43.36648115515709
            },
            {
                "_x": 54.068399012088776,
                "_y": 47.952899754047394
            },
            {
                "_x": 57.547168493270874,
                "_y": 60.06849879026413
            },
            {
                "_x": 56.65698516368866,
                "_y": 59.30737918615341
            },
            {
                "_x": 53.352203249931335,
                "_y": 53.74700975418091
            },
            {
                "_x": 55.16421389579773,
                "_y": 52.73248040676117
            },
            {
                "_x": 54.30792027711868,
                "_y": 50.287073493003845
            },
            {
                "_x": 56.62921768426895,
                "_y": 51.406083047389984
            },
            {
                "_x": 61.75590705871582,
                "_y": 49.42621463537216
            },
            {
                "_x": 58.185946226119995,
                "_y": 46.996744841337204
            },
            {
                "_x": 59.104294538497925,
                "_y": 52.078402280807495
            },
            {
                "_x": 59.6758975982666,
                "_y": 53.23713755607605
            },
            {
                "_x": 63.11369025707245,
                "_y": 57.89384078979492
            },
            {
                "_x": 59.583377838134766,
                "_y": 58.193197309970856
            },
            {
                "_x": 56.737426936626434,
                "_y": 60.28618371486664
            },
            {
                "_x": 57.91989076137543,
                "_y": 55.1614847779274
            },
            {
                "_x": 59.645320415496826,
                "_y": 54.15904486179352
            },
            {
                "_x": 56.31778907775879,
                "_y": 51.02936226129532
            },
            {
                "_x": 60.82181489467621,
                "_y": 49.81917029619217
            },
            {
                "_x": 55.79532015323639,
                "_y": 48.27823033928871
            },
            {
                "_x": 55.8296685218811,
                "_y": 51.67588955163956
            },
            {
                "_x": 56.5140979886055,
                "_y": 53.30827498435974
            }
        ]
    },
    "alignedRect": {
        "_imageDims": {
            "_width": 640,
            "_height": 480
        },
        "_score": 0.9969726800918579,
        "_classScore": 0.9969726800918579,
        "_className": "",
        "_box": {
            "_x": 233.64122031331064,
            "_y": 266.71635031104086,
            "_width": 87.42003915309907,
            "_height": 58.20412809848786
        }
    },
    "descriptor": {
        "0": -0.1308801770210266,
        "1": 0.06806538999080658,
        "2": 0.04188553988933563,
        "3": 0.013632962480187416,
        "4": -0.046428319066762924,
        "5": -0.0858062133193016,
        "6": -0.04144817963242531,
        "7": -0.14205355942249298,
        "8": 0.08978276699781418,
        "9": -0.06811366230249405,
        "10": 0.18811996281147003,
        "11": -0.02926700934767723,
        "12": -0.21618333458900452,
        "13": -0.11035367101430893,
        "14": -0.041475169360637665,
        "15": 0.10294466465711594,
        "16": -0.13155487179756165,
        "17": -0.07707983255386353,
        "18": -0.08945588022470474,
        "19": -0.1342315375804901,
        "20": 0.04618996009230614,
        "21": 0.018796421587467194,
        "22": 0.059828467667102814,
        "23": -0.016376124694943428,
        "24": -0.06740614026784897,
        "25": -0.25877368450164795,
        "26": -0.04517007991671562,
        "27": -0.08745883405208588,
        "28": 0.04976436123251915,
        "29": -0.14961786568164825,
        "30": 0.02754282020032406,
        "31": 0.06432141363620758,
        "32": -0.18404239416122437,
        "33": -0.04250606521964073,
        "34": -0.057311050593853,
        "35": 0.09518275409936905,
        "36": -0.004927500616759062,
        "37": -0.08939715474843979,
        "38": 0.21138633787631989,
        "39": -0.03334986791014671,
        "40": -0.10509881377220154,
        "41": 0.01236127968877554,
        "42": 0.04094588756561279,
        "43": 0.2447059154510498,
        "44": 0.15844061970710754,
        "45": -0.029864707961678505,
        "46": 0.00825350359082222,
        "47": -0.04043770954012871,
        "48": 0.07592961192131042,
        "49": -0.2151673287153244,
        "50": -0.007548382505774498,
        "51": 0.15137836337089539,
        "52": 0.08492425084114075,
        "53": 0.06393430382013321,
        "54": 0.054192543029785156,
        "55": -0.14771117269992828,
        "56": -0.00012020993017358705,
        "57": 0.08876818418502808,
        "58": -0.13093848526477814,
        "59": 0.07472975552082062,
        "60": 0.06526312977075577,
        "61": -0.06292298436164856,
        "62": -0.04345028102397919,
        "63": -0.08411991596221924,
        "64": 0.20527516305446625,
        "65": 0.06814416497945786,
        "66": -0.09656821191310883,
        "67": -0.10480866581201553,
        "68": 0.1449221819639206,
        "69": -0.11315561830997467,
        "70": -0.0500926673412323,
        "71": 0.07866086810827255,
        "72": -0.1091705858707428,
        "73": -0.17382623255252838,
        "74": -0.22086720168590546,
        "75": 0.09272301942110062,
        "76": 0.26206010580062866,
        "77": 0.14101020991802216,
        "78": -0.15955664217472076,
        "79": -0.0015154362190514803,
        "80": -0.12131261825561523,
        "81": -0.04923039302229881,
        "82": -0.010045360773801804,
        "83": 0.04141083359718323,
        "84": -0.021001586690545082,
        "85": -0.009797023609280586,
        "86": -0.1075759008526802,
        "87": 0.024742821231484413,
        "88": 0.15935377776622772,
        "89": -0.006157494615763426,
        "90": -0.026194991543889046,
        "91": 0.22436553239822388,
        "92": 0.013487246818840504,
        "93": -0.02912311814725399,
        "94": -0.0432882122695446,
        "95": 0.021509692072868347,
        "96": -0.1325419843196869,
        "97": 0.00992767233401537,
        "98": -0.10735304653644562,
        "99": -0.03789382427930832,
        "100": 0.10031192004680634,
        "101": -0.13777154684066772,
        "102": 0.02008216269314289,
        "103": 0.12952734529972076,
        "104": -0.1419118344783783,
        "105": 0.12874068319797516,
        "106": -0.04592717066407204,
        "107": -0.012741726823151112,
        "108": 0.010388444177806377,
        "109": -0.015663353726267815,
        "110": -0.05921920761466026,
        "111": 0.005484156310558319,
        "112": 0.1490471363067627,
        "113": -0.1980399638414383,
        "114": 0.22521638870239258,
        "115": 0.19821962714195251,
        "116": 0.06323521584272385,
        "117": 0.1333247870206833,
        "118": 0.05600897967815399,
        "119": 0.11760580539703369,
        "120": -0.009385794401168823,
        "121": 0.01038897130638361,
        "122": -0.13485996425151825,
        "123": -0.08883506059646606,
        "124": -0.007158135063946247,
        "125": 0.006225056014955044,
        "126": -0.016387375071644783,
        "127": 0.06650179624557495
    }
}




const getFaceAndDescriptor = (canvas, type = 'base64') => {
    if (!canvas) return Promise.reject(new Error('Foto no válida'));
  
    return new Promise(async (resolve, reject) => {
      try {
        const photo = {
          thumbnail: {
            b64: null,
            blob: null,
          },
          faces: [],
        };
        resizeToMax(canvas); //<- reduce canvas height and width if it necesary
        const result = await faceapi.detectAllFaces(canvas, faceDetectionOptionsFiles);
        if (!result) return reject(new Error('Cara no encontrada'));
        if (result.length > 1) {
          return reject(new Error(`Foto no válida, se encontraron ${result.length} rostros`));
        }
        if (result.length === 0) {
          return reject(new Error('La imagen no contiene un rostro o se encuentra muy lejos'));
        }
  
        let { box } = result[0];
        let region = new faceapi.Rect(box._x, box._y, box._width, box._height);
        const boxFace = box;
        let face = await faceapi.extractFaces(canvas, [region]);
  
        const landmarks = await faceapi.detectFaceLandmarksTiny(face[0]);
        box = landmarks.align();
        region = new faceapi.Rect(box._x, box._y, box._width, box._height);
        face = await faceapi.extractFaces(face[0], [region]);
        canvas2gray(face[0]); // Convierte el canvas a escala de grises
        const blobFace = await canvas2blob(face[0]);
        let descriptor = await faceapi.computeFaceDescriptor(face[0]); // get Float32Array
        // Encode descriptor to send a server
        descriptor =  btoa(String.fromCharCode.apply(null, new Uint8Array(descriptor.buffer)))
        // Push blob of face and descriptor
        photo.faces.push({
          blob: blobFace,
          descriptor,
        });
  
        box = boxFace;
        if (canvas.height > 240 && canvas.width > 320) {
          let x;
          let y;
          let h = canvas.height * 0.9;
          let w = box.width;
          const centerX = box.width / 2;
          const centerY = box.height / 2;
          x = box.x - centerX;
          if (x < 0) x = box.x;
          else w = box.width * 2;
          y = box.y - centerY;
          if (y < 0) y = 0;
          if (h - y < canvas.height) h -= y;
          else h = box.height;
          // Get thumbnail
          region = new faceapi.Rect(x, y, w, h); // region center imagen
        } else {
          region = new faceapi.Rect(box.x, box.y, box.width, box.height);
        }
  
        const thumbnail = await faceapi.extractFaces(canvas, [region]);
        const blobThumbnail = await canvas2blob(thumbnail[0]);
        photo.thumbnail = {
          blob: blobThumbnail,
        };
        if (type === 'base64') photo.thumbnail.b64 = thumbnail[0].toDataURL('image/jpeg');
  
        resolve(photo);
      } catch (error) {
        console.error(error);
        reject(error);
      }
    });
  };
  
  function canvas2blob(can, type = 'image/jpeg', quality = 0.97) {
    return Promise.try(() => {
      if (!can) throw new Error('Empty canvas');
      return new Promise((resolve, reject) => {
        can.toBlob(resolve, type, quality);
      });
    });
  }
  
  function resizeToMax(can, max_size = 640) {
    if (!can || !can.width || !can.height) return;
    let { width } = can;
    let { height } = can;
    if (width <= max_size && height <= max_size) return;
    if (width > height) {
      if (width > max_size) {
        height *= max_size / width;
        width = max_size;
      }
    } else if (height > max_size) {
      width *= max_size / height;
      height = max_size;
    }
    can.width = width;
    can.height = height;
  }
  
  function canvas2gray(c) {
    if (!c || !c.width || !c.height) return;
    const ctx = c.getContext('2d');
  
    const idataSrc = ctx.getImageData(0, 0, c.width, c.height); // original
    const idataTrg = ctx.createImageData(c.width, c.height); // empty data
    const dataSrc = idataSrc.data; // reference the data itself
    const dataTrg = idataTrg.data;
    const len = dataSrc.length;
    let i = 0;
    let luma;
  
    // convert by iterating over each pixel each representing RGBA
    for (; i < len; i += 4) {
      // calculate luma, here using Rec 709
      luma = dataSrc[i] * 0.2126 + dataSrc[i + 1] * 0.7152 + dataSrc[i + 2] * 0.0722;
  
      // update target's RGB using the same luma value for all channels
      dataTrg[i] = dataTrg[i + 1] = dataTrg[i + 2] = luma;
      dataTrg[i + 3] = dataSrc[i + 3]; // copy alpha
    }
    // put back luma data so we can save it as image
    ctx.putImageData(idataTrg, 0, 0);
  }
  