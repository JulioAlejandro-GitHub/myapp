<?phprequire_once '../comun/session.php';require_once '../comun/class.admin.php';require_once '../comun/class.session.php';if ($_SESSION['USUARIO_TIPO'] != 'vendedor') {    echo 'No autorizado';    exit;}$Admin   = new Admin();$Session = new Session();switch ($_POST['target']) {        case 'sucursal' :        switch ($_POST['action']) {            case 'add':                $_POST = str_replace("+", " ", $_POST);                                $rut_exists = $Session->rut_exists($_POST['rut']);                $result_img = true;                $result_sql = true;                if($rut_exists) {                    $result = 'ADD_EXISTS';                } else {                        //se seleccionó imagen                        if ($_FILES['logo']['tmp_name']) {                             $tmp_name = $_FILES['logo']['tmp_name'];                             $imagen = getimagesize($tmp_name);                             switch ($imagen[2]) {                                 case 1:                                     $imagen_tipo = "gif";                                     break;                                 case 2:                                      $imagen_tipo = "jpg";                                     break;                                 case 3:                                      $imagen_tipo = "png";                                     break;                             }                             if ($_FILES["logo"]["size"] > AUTOMOTORA_LOGO_MAXSIZEBYTES) {                                 $result_img_error = "ADD_IMG_MAXSIZEBITS";                                 $result_img = false;                             }                             else if ($imagen[0] > AUTOMOTORA_LOGO_MAXSIZEPIXELS || $imagen[1] > AUTOMOTORA_LOGO_MAXSIZEPIXELS) {                                 $result_img_error = "ADD_IMG_MAXSIZEPIXELS";                                 $result_img = false;                             }                             else if (!$imagen_tipo) {                                 $result_img_error = "ADD_IMG_FORMAT";                                 $result_img = false;                             }                             else {                                 if ( !@is_uploaded_file($_FILES['logo']['tmp_name']) ) {                                     $result_img_error = "ADD_ERROR_UPLOAD_IMG";                                     $result_img = false;                                 }                                 else {                                                                        $filename = $_POST['rut'].".".$imagen_tipo;                                    if (! @move_uploaded_file($_FILES['logo']['tmp_name'], PATH_UPLOAD_LOGOS_IMG.$filename) ) {                                        $result_img_error = "ADD_ERROR_MOVE_UPLOAD";                                        $result_img = false;                                    }                                    else {                                        $result_img = true;                                    }                                 }                             }                          }                                                if( ($result_img_error  != "ADD_IMG_MAXSIZEBITS"                           && $result_img_error  != "ADD_IMG_MAXSIZEPIXELS"                           && $result_img_error  != "ADD_IMG_FORMAT")                           || !$_FILES['logo']['tmp_name']                          || $result_img == true ) {                                                        $result_sql = $Admin->addSucursal (                                array(                                    'AUTOMOTORA_ID_MATRIZ'          => $_SESSION['AUTOMOTORA_ID_AUTOMOTORA'],                                    'AUTOMOTORA_RUT'                => $_POST['rut'],                                    'AUTOMOTORA_NOMBRE'             => $_POST['nombre'],                                    'AUTOMOTORA_TELEFONO'           => $_POST['telefono'],                                    'AUTOMOTORA_EMAIL'              => $_POST['email'],                                    'AUTOMOTORA_FAX'                => $_POST['fax'],                                    'AUTOMOTORA_RAZON_SOCIAL'       => $_POST['razonsocial'],                                    'AUTOMOTORA_IMG'                => $filename,                                    'AUTOMOTORA_MAPA'               => $_POST['map'],                                    'AUTOMOTORA_URL'                => $_POST['url'],                                    'AUTOMOTORA_DIRECCION'          => $_POST['direccion'],                                    'AUTOMOTORA_ID_CIUDAD'          => $_POST['ciudad'],                                    'AUTOMOTORA_HORARIO_LUN_VIE'    => $_POST['horario_lunvie'],                                    'AUTOMOTORA_HORARIO_SAB'        => $_POST['horario_sab'],                                    'AUTOMOTORA_HORARIO_DOM'        => $_POST['horario_dom']                                )                            );                                                        $Admin->insert_id;                            // last id                            //                             //                             //crea directorios para img catálogo//                            mkdir(PATH_MKDIR_SUCURSAL.$_POST['rut']."/thumbnails/125", 0777, true);//                            mkdir(PATH_MKDIR_SUCURSAL.$_POST['rut']."/thumbnails/215", 0777, true);                                                        mkdir(PATH_MKDIR_SUCURSAL.$Admin->insert_id."/thumbnails/125", 0777, true);                            mkdir(PATH_MKDIR_SUCURSAL.$Admin->insert_id."/thumbnails/215", 0777, true);                                                    }                                                if ($result_sql && $result_img) {                            $result = 'ADD_OK';                        }                        else if ( (!$result_sql && $result_img) || (!$result_sql && !$result_img) ) {                            $result = 'ADD_ERROR';                        }                        else if ($result_sql && !$result_img) {                            $result = $result_img_error;                        }                                        }                break;                            case 'edit':                 $_POST = str_replace("+", " ", $_POST);                                //sólo valida rut existente si se modificó el valor                if ($_POST['rut'] == $_POST['rut_ant']) {                    $rut_exists = false;                }                 else {                    $rut_exists = $Session->rut_exists($_POST['rut']);                }                                $result_img = true;                $result_sql = true;                                if($rut_exists) {                    $result = 'EDIT_EXISTS';                }                                else {                        //se seleccionó imagen                        if ($_FILES['logo']['tmp_name']) {                             $tmp_name = $_FILES['logo']['tmp_name'];                             $imagen = getimagesize($tmp_name);                             switch ($imagen[2]) {                                 case 1:                                     $imagen_tipo = "gif";                                     break;                                 case 2:                                      $imagen_tipo = "jpg";                                     break;                                 case 3:                                      $imagen_tipo = "png";                                     break;                             }                             if ($_FILES["logo"]["size"] > AUTOMOTORA_LOGO_MAXSIZEBYTES) {                                 $result_img_error = "EDIT_IMG_MAXSIZEBITS";                                 $result_img = false;                             }                             else if ($imagen[0] > AUTOMOTORA_LOGO_MAXSIZEPIXELS || $imagen[1] > AUTOMOTORA_LOGO_MAXSIZEPIXELS) {                                 $result_img_error = "EDIT_IMG_MAXSIZEPIXELS";                                 $result_img = false;                             }                             else if (!$imagen_tipo) {                                 $result_img_error = "EDIT_IMG_FORMAT";                                 $result_img = false;                             }                             else {                                 if ( !@is_uploaded_file($_FILES['logo']['tmp_name']) ) {                                     $result_img_error = "EDIT_ERROR_UPLOAD_IMG";                                     $result_img = false;                                 }                                 else {                                                                        $filename = $_POST['rut'].".".$imagen_tipo;                                    if (! @move_uploaded_file($_FILES['logo']['tmp_name'], PATH_UPLOAD_LOGOS_IMG.$filename) ) {                                        $result_img_error = "EDIT_ERROR_MOVE_UPLOAD";                                        $result_img = false;                                    }                                    else {                                        $result_img = true;                                    }                                 }                             }                          }                                                if( ($result_img_error  != "EDIT_IMG_MAXSIZEBITS"                           && $result_img_error  != "EDIT_IMG_MAXSIZEPIXELS"                           && $result_img_error  != "EDIT_IMG_FORMAT")                           || !$_FILES['logo']['tmp_name']                          || $result_img == true ) {                                                        $result_sql = $Admin->editSucursal (                                array(                                    'AUTOMOTORA_ID_AUTOMOTORA'      => $_POST['id_sucursal'],                                    'AUTOMOTORA_RUT'                => $_POST['rut'],                                    'AUTOMOTORA_NOMBRE'             => $_POST['nombre'],                                    'AUTOMOTORA_TELEFONO'           => $_POST['telefono'],                                    'AUTOMOTORA_EMAIL'              => $_POST['email'],                                    'AUTOMOTORA_FAX'                => $_POST['fax'],                                    'AUTOMOTORA_RAZON_SOCIAL'       => $_POST['razonsocial'],                                    'AUTOMOTORA_IMG'                => $filename,                                    'AUTOMOTORA_MAPA'               => $_POST['map'],                                                                'AUTOMOTORA_URL'                => $_POST['url'],                                    'AUTOMOTORA_DIRECCION'          => $_POST['direccion'],                                    'AUTOMOTORA_ID_CIUDAD'          => $_POST['ciudad'],                                    'AUTOMOTORA_HORARIO_LUN_VIE'    => $_POST['horario_lunvie'],                                    'AUTOMOTORA_HORARIO_SAB'        => $_POST['horario_sab'],                                    'AUTOMOTORA_HORARIO_DOM'        => $_POST['horario_dom']                                )                            );                            if ($_POST['rut'] != $_POST['rut_ant']) {                                //cambió rut, renombra directorio con img catálogo                                //rename(PATH_MKDIR_SUCURSAL.$_POST['rut_ant'], PATH_MKDIR_SUCURSAL.$_POST['rut']);                            }                        }                                                if ($result_sql && $result_img) {                            $result = 'EDIT_OK';                        }                        else if ( (!$result_sql && $result_img) || (!$result_sql && !$result_img) ) {                            $result = 'EDIT_ERROR';                        }                        else if ($result_sql && !$result_img) {                            $result = $result_img_error;                        }                }                                break;            case 'delete':                                $result = $Admin->deleteSucursal (                    array(                        'AUTOMOTORA_ID_AUTOMOTORA' => $_POST['id_sucursal'],                        'AUTOMOTORA_SUCURSAL'      => $_SESSION['AUTOMOTORA_ID_AUTOMOTORA']                                            )                );                $result = $result ? 'DELETE_OK' : 'DELETE_ERROR';                break;        }        break;    case 'vendedor' :        switch ($_POST['action']) {            case 'add':                $email_exists = $Session->email_exists($_POST['email']);                if($email_exists) {                    $result = 'ADD_EXISTS';                }                else {                    $result = $Admin->addVendedor (                        array(                            'VENDEDOR_ID_AUTOMOTORA'      => $_POST['id_sucursal'],                            'VENDEDOR_EMAIL'              => $_POST['email'],                            'VENDEDOR_PASSWORD'           => $_POST['password'],                            'VENDEDOR_NOMBRE'             => $_POST['nombre'],                            'VENDEDOR_APELLIDO_PATERNO'   => $_POST['apellidopaterno'],                            'VENDEDOR_APELLIDO_MATERNO'   => $_POST['apellidomaterno'],                            'VENDEDOR_RUT'                => $_POST['rut'],                            'VENDEDOR_TELEFONO'           => $_POST['telefono'],                            'VENDEDOR_MOVIL'              => $_POST['movil'],                            'VENDEDOR_DIRECCION'          => $_POST['direccion'],                        )                    );                    $result = $result ? 'ADD_OK' : 'ADD_ERROR';                }                break;                        case 'edit':                                //sólo valida correo existente si se modificó el valor                if ($_POST['email'] == $_POST['email_ant']) {                    $email_exists = false;                }                 else {                    $email_exists = $Session->email_exists($_POST['email']);                }                                if($email_exists) {                    $result = 'EDIT_EXISTS';                }                else {                    $result = $Admin->editVendedor (                        array(                            'VENDEDOR_ID_VENDEDOR'        => $_POST['id_vendedor'],                            'VENDEDOR_ID_AUTOMOTORA'      => $_POST['id_sucursal'],                            'VENDEDOR_EMAIL'              => $_POST['email'],                            'VENDEDOR_PASSWORD'           => $_POST['password'],                            'VENDEDOR_NOMBRE'             => $_POST['nombre'],                            'VENDEDOR_APELLIDO_PATERNO'   => $_POST['apellidopaterno'],                            'VENDEDOR_APELLIDO_MATERNO'   => $_POST['apellidomaterno'],                            'VENDEDOR_RUT'                => $_POST['rut'],                            'VENDEDOR_TELEFONO'           => $_POST['telefono'],                            'VENDEDOR_MOVIL'              => $_POST['movil'],                            'VENDEDOR_DIRECCION'          => $_POST['direccion'],                        )                    );                    if($result) {                                                $result = 'EDIT_OK';                                                if ($_POST['id_vendedor'] == $_SESSION['VENDEDOR_ID_VENDEDOR']) {                            $_SESSION['USUARIO_NOMBRE'] = $_POST['nombre'];                        }                    }                    else {                        $result = 'EDIT_ERROR';                    }                }                break;                            case 'delete':                $result = $Admin->deleteVendedor (                    array(                        'VENDEDOR_ID_VENDEDOR'      => $_POST['id_vendedor'],                        'AUTOMOTORA_SUCURSAL'       => $_SESSION['AUTOMOTORA_ID_AUTOMOTORA']                                            )                );                $result = $result ? 'DELETE_OK' : 'DELETE_ERROR';                break;        }        break;        case 'modelo':            switch ($_POST['action']) {                case 'add':                    $result = $Admin->addModelo (                        array(                            'CARROCERIA_ID_CARROCERIA'        => $_POST['id_carroceria'],                            'MARCA_ID_MARCA'                  => $_POST['id_marca'],                            'MODELO_NOMBRE'                   => $_POST['nombre'],                        )                    );                    if($result) {                        $result = 'ADD_OK';                    }                    else {                        $result = 'ADD_ERROR';                    }                    break;            }            break;        }echo $result;?>